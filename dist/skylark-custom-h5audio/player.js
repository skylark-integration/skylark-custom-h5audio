/**
 * skylark-custom-h5audio - A version of custom-html5-vedio that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx","skylark-domx-styler","skylark-domx-noder","skylark-domx-eventer","skylark-domx-query","skylark-domx-plugins-base"],function(t,i,s,e,a,l){"use strict";function n(t,i){var s=document.createElement(t);if(i)for(var e in i)void 0!==s[e]&&(s[e]=i[e]);return s}Element.prototype.offset=function(){var t=this.getBoundingClientRect(),i=window.pageXOffset||document.documentElement.scrollLeft,s=window.pageYOffset||document.documentElement.scrollTop;return{top:t.top+s,left:t.left+i}},Element.prototype.css=function(t){if("string"==typeof t)return getComputedStyle(this,"")[t];if("object"==typeof t)for(var i in t)void 0!==this.style[i]&&(this.style[i]=t[i])};var o=l.Plugin.inherit({klassName:"CustomHtml5Audio",pluginName:"intg.custom_html5_audio",options:{volume:.5,autoPlay:!1,notification:!1,playList:[]},_construct:function(t,i){l.Plugin.prototype._construct.call(this,t,i),this._index=0,this._repeating=!1,this._shuffling=null,this._played=[],this._seeking=!1,this._rightClick=!1,this._apActive=!1;this.$(),this.options.selectors;if(this._player=n("div",{className:"ap",id:"ap",innerHTML:'  <div class="ap-inner">    <div class="ap-panel">      <div class="ap-item ap--playback">        <button class="ap-controls ap-prev-btn">          <i class="material-icons md-dark">skip_previous</i>        </button>        <button class="ap-controls ap-toggle-btn">            <i class="material-icons md-dark ap--play">play_arrow</i>            <i class="material-icons md-dark ap--pause">pause</i>        </button>        <button class="ap-controls ap-next-btn">          <i class="material-icons md-dark">skip_next</i>        </button>      </div>      <div class="ap-item ap--track">        <div class="ap-info">          <div class="ap-title">Unknown</div>          <div class="ap-time">            <span class="ap-time--current">--</span>            <span> / </span>            <span class="ap-time--duration">--</span>          </div>          <div class="ap-progress-container">            <div class="ap-progress">              <div class="ap-bar"></div>              <div class="ap-preload-bar"></div>            </div>          </div>        </div>      </div>      <div class="ap-item ap--settings">        <div class="ap-controls ap-volume-container">          <button class="ap-controls ap-volume-btn">              <i class="material-icons md-dark ap--volume-on">volume_up</i>              <i class="material-icons md-dark ap--volume-off">volume_mute</i>          </button>          <div class="ap-volume">            <div class="ap-volume-progress"><div class="ap-volume-bar"></div></div>          </div>        </div>        <button class="ap-controls ap-repeat-btn">          <i class="material-icons md-dark">repeat</i>        </button>        <button class="ap-controls ap-shuffle-btn">          <i class="material-icons md-dark">shuffle</i>        </button>        <button class="ap-controls ap-playlist-btn">          <i class="material-icons md-dark">queue_music</i>        </button>      </div>    </div>  </div>'}),this._apActive||null===this._player)return;let s=this.options;this._elm.appendChild(this._player),this._playBtn=this._player.querySelector(".ap-toggle-btn"),this._prevBtn=this._player.querySelector(".ap-prev-btn"),this._nextBtn=this._player.querySelector(".ap-next-btn"),this._repeatBtn=this._player.querySelector(".ap-repeat-btn"),this._shuffleBtn=this._player.querySelector(".ap-shuffle-btn"),this._volumeBtn=this._player.querySelector(".ap-volume-btn"),this._plBtn=this._player.querySelector(".ap-playlist-btn"),this._curTime=this._player.querySelector(".ap-time--current"),this._durTime=this._player.querySelector(".ap-time--duration"),this._trackTitle=this._player.querySelector(".ap-title"),this._progressBar=this._player.querySelector(".ap-bar"),this._progressBarContaner=this._player.querySelector(".ap-progress-container"),this._preloadBar=this._player.querySelector(".ap-preload-bar"),this._volumeBar=this._player.querySelector(".ap-volume-bar"),this._volumeBarContaner=this._player.querySelector(".ap-volume-container"),this._playList=s.playList,this.listenTo(a(this._playBtn),"click",this.playToggle),this.listenTo(a(this._volumeBtn),"click",this.volumeToggle),this.listenTo(a(this._repeatBtn),"click",this.repeatToggle),this.listenTo(a(this._shuffleBtn),"click",this.shuffleToggle),this.listenTo(a(this._progressBarContaner),"mousedown",this.handlerBar),this.listenTo(a(this._progressBarContaner),"mousemove",this.seek),this.listenTo(a(document),"mouseup",this.seekingFalse),this.listenTo(a(this._volumeBarContaner),"mousedown",this.handlerVol),this.listenTo(a(this._volumeBarContaner),"mousemove",this.setVolume),this.listenTo(a(document),"mouseup",this.seekingFalse),this.listenTo(a(this._prevBtn),"click",this.prev),this.listenTo(a(this._nextBtn),"click",this.next),this._imageDiv=n("div",{className:"ap-image"}),this._elm.appendChild(this._imageDiv),this._apActive=!0,this.renderPL(),this.listenTo(a(this._plBtn),"click",this.plToggle),this._audio=new Audio,this._audio.volume=s.volume,this.isEmptyList()?this.empty():(this._audio.src=this._playList[this._index].file,this._audio.preload="auto",this._trackTitle.innerHTML=this._playList[this._index].title,this._volumeBar.style.height=100*this._audio.volume+"%",this._volumeLength=this._volumeBar.css("height"),this.listenTo(a(this._audio),"error",this.error),this.listenTo(a(this._audio),"timeupdate",this.update),this.listenTo(a(this._audio),"ended",this.doEnd),this.listenTo(a(this._audio),"play",()=>{this._playBtn.classList.add("playing")},!1),this.listenTo(a(this._audio),"pause",()=>{this._playBtn.classList.remove("playing")},!1),s.autoPlay&&(this._audio.play(),this._plLi[this._index].classList.add("pl-current")))},renderPL:function(){var t=[],i='<li data-track="{count}"><div class="pl-number"><div class="pl-count"><i class="material-icons">audiotrack</i></div><div class="pl-playing"><div class="eq"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div></div></div><div class="pl-title">{title}</div><button class="pl-remove"><i class="material-icons">delete</i></button></li>';this._playList.forEach(function(s,e){t.push(i.replace("{count}",e).replace("{title}",s.title))}),this._pl=n("div",{className:"pl-container hide",id:"pl",innerHTML:this.isEmptyList()?'<div class="pl-empty">PlayList is empty</div>':'<ul class="pl-list">'+t.join("")+"</ul>"}),this._elm.insertBefore(this._pl,this._player.nextSibling),this._plLi=this._pl.querySelectorAll("li"),this.listenTo(a(this._pl),"click",this.listHandler)},listHandler:function(t){if(t.preventDefault(),"pl-title"===t.target.className){var i=parseInt(t.target.parentNode.getAttribute("data-track"),10);this._index=i,this.play(),this.plActive()}else for(var s=t.target;s.className!==this._pl.className;){if("pl-remove"===s.className){var e=parseInt(s.parentNode.getAttribute("data-track"),10);return this._playList.splice(e,1),s.parentNode.parentNode.removeChild(s.parentNode),this._plLi=this._pl.querySelectorAll("li"),[].forEach.call(this._plLi,function(t,i){t.setAttribute("data-track",i)}),this._audio.paused?this.isEmptyList()?this.empty():(this._audio.src=this._playList[index].file,document.title=this._trackTitle.innerHTML=this._playList[index].title,this._progressBar.style.width=0):this._isDel===this._index&&this.play(),void(this._isDel<this._index&&this._index--)}s=s.parentNode}},plActive:function(){if(this._audio.paused)this._plLi[index].classList.remove("pl-current");else{for(var t=this._index,i=0,s=this._plLi.length;s>i;i++)this._plLi[i].classList.remove("pl-current");if(this._plLi[t].classList.add("pl-current"),this._imageDiv.innerHTML="",this._playList[t].icon){let i=n("img",{src:this._playList[t].icon});this._imageDiv.appendChild(i)}}},error:function(){this.isEmptyList()||this.next()},play:function(){this._index=this._index>this._playList.length-1?0:this._index,this._index<0&&(this._index=this._playList.length-1),this.isEmptyList()?this.empty():(this._played.push(this._index),this._audio.src=this._playList[this._index].file,this._audio.preload="auto",document.title=this._trackTitle.innerHTML=this._playList[this._index].title,this._audio.play(),this.plActive())},prev:function(){this._played.length>1?this._index=this._played.splice(-2)[0]:this._index=0,this.play()},next:function(t){if(this._shuffling){if(0===this._shuffling.length){if(!this._repeating&&!this._interactive)return this._audio.pause(),void this.plActive();this._shuffling=[...Array(this._playList.length).keys()]}let t=Math.floor(Math.random()*this._shuffling.length);this._index=this._shuffling.splice(t,1)[0]}else{if(this._index===this._playList.length-1&&!this._repeating&&!this._interactive)return this._audio.pause(),this.plActive(),void this._playBtn.classList.remove("playing");this._index=this._index===this._playList.length-1?0:this._index+1}this.play()},isEmptyList:function(){return 0===this._playList.length},empty:function(){this._audio.pause(),this._audio.src="",this._trackTitle.innerHTML="queue is empty",this._curTime.innerHTML="--",this._durTime.innerHTML="--",this._progressBar.style.width=0,this._preloadBar.style.width=0,this._pl.innerHTML='<div class="pl-empty">PlayList is empty</div>'},playToggle:function(){this.isEmptyList()||(this._audio.paused?(this._audio.play(),this._playBtn.classList.add("playing")):(this._audio.pause(),this._playBtnclassList.remove("playing")),this.plActive())},volumeToggle:function(){this._audio.muted?(0===parseInt(this._volumeLength,10)?(this._volumeBar.style.height="100%",this._audio.volume=1):this._volumeBar.style.height=this._volumeLength,this._audio.muted=!1,this._volumeBtn.classList.remove("muted")):(this._audio.muted=!0,this._volumeBar.style.height=0,this._volumeBtn.classList.add("muted"))},repeatToggle:function(){var t=this._repeatBtn.classList;t.contains("ap-active")?(this._repeating=!1,t.remove("ap-active")):(this._repeating=!0,t.add("ap-active"))},shuffleToggle:function(){var t=this._shuffleBtn.lassList;t.contains("ap-active")?(shuffling=null,t.remove("ap-active")):(shuffling=[...Array(this._playList.length).keys()],t.add("ap-active"))},plToggle:function(){this._pl.classList.toggle("ap-active"),this._pl.classList.toggle("hide")},update:function(){if(0!==this._audio.readyState){var t=Math.round(this._audio.currentTime*(100/this._audio.duration));this._progressBar.style.width=t+"%";var i=Math.floor(this._audio.currentTime/60),s=Math.floor(this._audio.currentTime-60*i),e=Math.floor(this._audio.duration/60),a=Math.floor(this._audio.duration-60*e);s<10&&(s="0"+s),a<10&&(a="0"+a),this._curTime.innerHTML=i+":"+s,this._durTime.innerHTML=e+":"+a;var l=this._audio.buffered;if(l.length){var n=Math.round(100*l.end(0)/this._audio.duration);this._preloadBar.style.width=n+"%"}}},doEnd:function(){this.next(!1)},moveBar:function(t,i,s){var e;if("horizontal"===s)return e=Math.round(100*(t.clientX-i.offset().left+window.pageXOffset)/i.parentNode.offsetWidth),i.style.width=e+"%",e;var a=i.offset().top+i.offsetHeight-window.pageYOffset;return(e=Math.round(a-t.clientY))>100&&(e=100),e<0&&(e=0),this._volumeBar.style.height=e+"%",e},handlerBar:function(t){this._rightClick=3===t.which,this._seeking=!0,this.seek(t)},handlerVol:function(t){this._rightClick=3===t.which,this._seeking=!0,this.setVolume(t)},seek:function(t){if(this._seeking&&!1===this._rightClick&&0!==this._audio.readyState){var i=this.moveBar(t,this._progressBar,"horizontal");this._audio.currentTime=this._audio.duration*(i/100)}},seekingFalse:function(){this._seeking=!1},setVolume:function(t){if(this._volumeLength=this._volumeBar.css("height"),this._seeking&&!1===this._rightClick){var i=this.moveBar(t,this._volumeBar.parentNode,"vertical")/100;i<=0?(this._audio.volume=0,this._volumeBtn.classList.add("muted")):(this._audio.muted&&(this._audio.muted=!1),this._audio.volume=i,this._volumeBtn.classList.remove("muted"))}},destroy:function(){this._apActive&&(s.remove(this._player),s.remove(this._pl),this._audio.pause(),this._apActive=!1)}});return l.register(o),o});
//# sourceMappingURL=sourcemaps/player.js.map
